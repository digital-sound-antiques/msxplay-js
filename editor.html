<!DOCTYPE html>
<html>
<head>
	<meta content="text/html" charset="utf-8">

	<title>MML to MGS Compiler (MGSC.COM) on Browser</title>

	<meta property="og:type" content="website"/>
	<meta name="keywords" content="MSX, YM2413, OPLL, PSG, SCC, MGSDRV, JavaScript, Emscripten, MML">
	<meta name="description" content="A MSX sound emulation player for JavaScript.">
	<meta property="og:title" content="MSXplay.js">
	<meta property="og:site_name" content="MSXplay.js">
	<meta property="og:description" content="A MSX sound emulation player for JavaScript.">
	<meta property="og:image" content="http://digital-sound-antiques.github.io/msxplay-js/img/ogp.png">

	<script src="dist/msxplay-bundle.js"></script>
	<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<link href='css/msxplay.css' rel='stylesheet' type='text/css'>
	<link href='css/style.css' rel='stylesheet' type='text/css'>
	<link href="css/editor.css" rel='stylesheet' type='text/css'>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/ace.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/theme-xcode.js"></script>

	<script>
  	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  	ga('create', 'UA-77432401-1', 'auto');
  	ga('send', 'pageview');
	</script>

	<script src="js/lang-switcher.js"></script>

	<script>
		"use strict"

		function loadTextFromUrl(url, complete) {

			var xhr = new XMLHttpRequest();
			xhr.open("GET",url,true);
			xhr.responseType = "text";
			xhr.addEventListener('load',function(){
				if(xhr.status == 200 || xhr.status == 304 || xhr.status == 0) {
					if(complete) complete(xhr.response, url, null);
				} else if(xhr.status == 404) {
					var err = new Error("File Not Found: " + url);
					if(complete) complete(null, url, err);
				} else {
					var err = new Error(xhr.statusText);
					if(complete) complete(null, url, err);
				} 
			});
			xhr.addEventListener('error',function(e){
				var err = new Error("Load Error: Check 'Access-Control-Allow-Origin' header is present for the target resource. See browser's development panel for detail. If you run this script local browser, `--allow-file-access-from-files` or the equivalent option is required.");
				if(complete) complete(null, url, err);
			});
			xhr.send();

		}

		// Prevent unexpected location change.
		var contentChanged = false;
		window.addEventListener('beforeunload',function(event) {
			if(contentChanged) {
				storeToLocalStorage();
			}
		});

		var editor;
		function createAceEditor() {
			try {
				editor = ace.edit("editor");
			  	editor.setTheme("ace/theme/xcode");
			  	//editor.getSession().setMode("ace/mode/text");
			  	editor.commands.bindKey("Ctrl-P", "golineup");
			  	editor.$blockScrolling = Infinity;
    			editor.getSession().setUseWrapMode(true);
    			editor.setShowPrintMargin(false);
    			editor.resize(true);
    			editor.setOptions({
    				indentedSoftWrap: false
    			});
    			editor.on('change',function() {
    				contentChanged = true;
    			});
    		} catch(e) {
    			window.alert('Failed to create the Ace editor instance. Please check your network connection.');
    		}
    	}

    	var marker = null;
    	function addErrorMarker(line) {
    		var range = ace.require('ace/range');
    		marker = editor.getSession().addMarker(new range.Range(line, 0, line, 2000), "mml-error", "line", true);
    	}

    	function removeErrorMarker() {
    		if(marker) {
    			editor.getSession().removeMarker(marker);
    			marker = null;
    		}
    	}

    	function highlightError(message) {
    		var m = message.match(/.* in ([0-9]+)/i);
    		if(m) {
    			var line = parseInt(m[1]);
    			addErrorMarker(line);
    			editor.gotoLine(line+1, 0, true); 
    		}
    		document.getElementById('message').classList.remove('minimized');
    	}

    	var lastCompiledMGS = null;

    	function getMetaMMLInfo(mml) {
    		var result = {};
    		var m;
    		m = mml.match(/^;\[.*duration=(auto|[0-9a-z]+).*\]/im);
    		if(m) {
    			if(m[1]!='auto') {
    				result.duration = m[1];
    			}
    		}

    		m = mml.match(/^;\[.*fade=([0-9a-z]+).*\]/im);
    		if(m) {
    			result.fade = m[1];
    		}

    		m = mml.match(/^;\[.*gain=([0-9]+(?:\.[0-9]+)).*\]/im);
    		if(m) {
    			result.gain = m[1];
    		}
    		return result;
    	}

		function compile() {
			if(contentChanged) {
				storeToLocalStorage();
				contentChanged = false;
			}

			var player = document.getElementById('player');

			MSXPlayUI.stop();
			MSXPlayUI.releaseKSS(player.dataset.hash);

			removeErrorMarker();
			var mml = editor.getValue();
			var result = MGSC.compile(mml);

			document.querySelector('#message pre').textContent = result.message;

			if(result.mgs.length==0) {
				highlightError(result.message);
				lastCompiledMGS = null
			} else {
				lastCompiledMGS = result.mgs;
				player.dataset.duration = null;
				player.dataset.gain = 1.0;			
				MSXPlayUI.setDataToPlayer(player, result.mgs, "mml.mgs");

				var info = getMetaMMLInfo(mml);
				if(info.duration) player.dataset.duration = info.duration;
				if(info.fade) player.dataset.fade = info.fade;
				if(info.gain) player.dataset.gain = info.gain;

				if(document.getElementById('autoplay').checked) {
					MSXPlayUI.play(player);
				}
			}
			editor.focus();
		}

		function loadText(text) {
			editor.setValue(text,-1);
			editor.focus();
			contentChanged = false;
			removeErrorMarker();
			clearLocalStorage();
		}

		function loadFromUrl(url) {
			loadTextFromUrl(url, function(mml,url,err) {
				if(mml) {
					loadText(mml);
				} else {
					editor.setValue(err.toString(),-1);
					contentChanged = false;
				}
			});
		}

		function loadFromFile(file, complete) {
		    var reader = new FileReader();
    		reader.onloadend = function() {
      			loadText(reader.result);
      			if(complete) complete();
    		}
    		reader.readAsText(file);
		}

		function openFile(e) {
			if(0<e.target.files.length) {
				loadFromFile(e.target.files[0]);
			}
		}

		function clearFile(e) {
			showDialog('confirm-clear',function(value){
				if(value=="ok") {
					editor.setValue('',-1);
					clearLocalStorage();
					contentChanged = false;
				}
			});
		}

		var AUTOBACKUP_KEY = 'mgsc.editor.autobackup'; 

		function clearLocalStorage() {
			localStorage.removeItem(AUTOBACKUP_KEY);
		}

		function storeToLocalStorage() {
			var text = editor.getValue();
			if(/^\s*$/.test(text)) {
				localStorage.removeItem(AUTOBACKUP_KEY);
			} else {
				localStorage.setItem(AUTOBACKUP_KEY, editor.getValue());
			}
		}

		function restoreFromLocalStorage() {
			editor.setValue(localStorage.getItem(AUTOBACKUP_KEY),-1);
			editor.focus();
			contentChanged = false;
		}

		document.addEventListener('keydown', function(e) {
			if( e.keyCode == 83 && (e.metaKey || e.ctrlKey) ) {
				e.preventDefault();
				storeToLocalStorage();
			}

			if (e.keyCode == 8) {
				if(e.target == document.body) {
					e.preventDefault();
				}
			}
		});

		var saveAs = function (data, fileName, type) {
			var a = document.getElementById("download-helper");
			var url = a.href;
			if(url) { 
				window.URL.revokeObjectURL(url);
			}

            var blob = new Blob([data], {type: type});

            if(navigator.msSaveOrOpenBlob) {

            	navigator.msSaveOrOpenBlob(blob,fileName);

            } else {
            	a.href = window.URL.createObjectURL(blob);
            	a.download = fileName;
            	a.click();
            }
        	
		};

		function downloadMML() {
			saveAs(editor.getValue(), Date.now() + ".mml", "text/plain");
		};

		function downloadMGS() {
			if(lastCompiledMGS) {
				saveAs(lastCompiledMGS, Date.now() + ".mgs", "application/octet-stream");
			} else {
				showDialog('no-mgs');
			}
		};

		function showDialog(id, complete) {
			var dialog = document.getElementById(id);
			var stage = document.getElementById('modal-stage');
			var listener = function(e) {

				var target = e.target;
				while(target) {
					if(target.dataset && target.dataset.value) {
						dialog.style.display = 'none';
						stage.style.display = 'none';
						dialog.removeEventListener('click',listener);
						if(complete) complete(target.dataset.value);
					}
					target = target.parentNode;
				}
			};
			dialog.addEventListener('click', listener);
			stage.style.display = 'block';
			dialog.style.display = 'block';
			dialog.style.width = dialog.offsetWidth + 'px';
			dialog.style.height = dialog.offsetHeight + 'px';
			dialog.style.position = 'absolute';
		}

		var dragCounter = 0;

		function onDragOver(e) {
  			e.preventDefault();
		}

		function onDragEnter(e) {
			e.preventDefault();
			if(dragCounter==0) {
				document.getElementById('editor').style.borderColor = 'red';
			}
			dragCounter++;
		}

		function onDragLeave(e) {
			dragCounter--;
			if(dragCounter==0) {
				document.getElementById('editor').style.borderColor = null;
			}
		}

		function onDrop(e) {
			dragCounter = 0;
			document.getElementById('editor').style.borderColor = null;
			e.preventDefault();
  			if(0<e.dataTransfer.files.length) {
				loadFromFile(e.dataTransfer.files[0], compile);
			}
  		}

  		function selectSample() {
  			showDialog('select-sample', function(value) {
  				if(value != "cancel") {
  					loadFromUrl(value);
  				}
  			});
  		}

		window.addEventListener('DOMContentLoaded', function() {

			var elem = document.body;
  			elem.addEventListener("dragover", onDragOver);
			elem.addEventListener("dragenter", onDragEnter);
			elem.addEventListener("dragleave", onDragLeave);
  			elem.addEventListener("drop", onDrop);

			MSXPlayUI.install(document.body);
			createAceEditor();

			if(localStorage.getItem(AUTOBACKUP_KEY)) {
				restoreFromLocalStorage();
			} else {
				selectSample();
			}

			document.getElementById('open-file').addEventListener('change',openFile);

			var mbox = document.getElementById('message');
			mbox.addEventListener('click',function(e) {				
				if(mbox.classList.contains('minimized')) {
					mbox.classList.remove('minimized');
				} else {
					if(e.target == document.querySelector('#message .title')) {
						mbox.classList.add('minimized');
					}
				}
			},true);

		});
	</script>
</head>
<body>
	<a id="download-helper" style="display:none"></a>

	<section class="page-header short">
		<nav class="root-nav">
			<ul>
			<li><a href="index.html">Home</a></li>
			<li class="selected">MML Editor</li>
			</ul>
		</nav>
	</section>

	<section class="actions">
		<input id="open-file" type="file" accept=".mml,.mus,.txt" style="display:none;" />
		<button onclick="document.getElementById('open-file').click();">Open File</button>
		<button onclick="selectSample()">Open Sample</button>
		<div style="display:inline-block;width:64px;"></div>
		<button onclick="compile()">Compile</button>
		<input id="autoplay" type="checkbox" checked> <label for="autoplay">play after compile</label>		
		&nbsp;
	</section>

	<div id="editor"></div>
	<div id="editor-foot">
		<div style="float:left;">MML file can be dropped to the editor.</div>
		<div style="float:right;">[<a target="_blank" href="http://www.gigamix.jp/mgsdrv/MGSC111.TXT">MML?</a>]</div>
		<div style="float:right;">Download as <a onclick="downloadMML()">MML</a> or <a onclick="downloadMGS()">MGS</a></div>
	</div>

	<div id="message" class="minimized">
		<div class="title">Console</div>
		<pre></pre>
	</div>
	<div id="player" class="msxplay bottom-fixed"></div>

	<!-- Dialogs -->

	<div id="modal-stage">

		<div id="confirm-restore" class="dialog" style="width:280px">
			<div class="content">
				<p lang="ja">前回、編集していた内容が残っています。読み込みますか？</p>
				<p lang="en">The last text you were editing is found. Recover it?</p>
			</div>
			<div class="button-area">
				<div class="button" data-value="yes">YES</div>
				<div class="button" data-value="no">NO</div>
			</div>
		</div>

		<div id="select-sample" class="dialog" style="width:392px">
			<div class="content">
				<p lang="ja">編集したいMMLを選んでください。</p>
				<p lang="en">Choose a sample MML file to open.</p>
			</div>
			<ul class="item-list">
				<li data-value="demo/blank.mml">
					<div class="title" lang="ja">新しいMML</div>
					<div class="title" lang="en">New MML</div>
					<div class="subtext" lang="ja">テンプレートから新規作成</div>
					<div class="subtext" lang="en">a new MML template</div>				
				</li>
				<li data-value="demo/grider.mml">
					<div class="title">Gun Rider <div class="chips"><i>OPLL</i></div></div>
					<div class="subtext">by J. arranged by Brezza</div>
				</li>
				<li data-value="demo/p52_arbl.mml">
					<div class="title">Arabiyaan (Long Version)<div class="chips"><i>PSG</i><i>SCC</i></div></div>
					<div class="subtext">by Wiz.</div>
				</li>
				<li data-value="demo/contrail.mml">
					<div class="title">[MSX Rock] Contrail<div class="chips"><i>PSG</i><i>SCC</i><i>OPLL</i></div></div>
					<div class="subtext">by DRM</div>
				</li>
				<li data-value="demo/es56.mml">
					<div class="title">Evil Swrod -Wilderness- <div class="chips"><i>PSG</i><i>OPLL</i></div></div>
					<div class="subtext">by DRM, arranged by Brezza</div>
				</li>
				<li data-value="demo/es59.mml">
					<div class="title">Evil Swrod -Fire master- <div class="chips"><i>PSG</i><i>OPLL</i></div></div>
					<div class="subtext">by DRM, arranged by Brezza</div>
				</li>
			</ul>
			<div class="button-area">
				<div class="button" data-value="cancel">Close</div>
			</div>
		</div>

		<div id="confirm-clear" class="dialog" style="width:280px">
			<div class="content">
				<p lang="ja">テキストを消去します。よろしいですか？</p>
				<p lang="en">Are you sure to clear all the text?</p>
			</div>
			<div class="button-area">
				<div class="button" data-value="ok">OK</div>
				<div class="button" data-value="cancel">Cancel</div>
			</div>
		</div>

		<div id="no-mgs" class="dialog" style="width:280px">
			<div class="content">
				<p lang="ja">MGSデータがありません。先にMMLをコンパイルしてください。</p>
				<p lang="en">No MGS data. Please compile the MML first.</p>
			</div>
			<div class="button-area">
				<div class="button" data-value="ok">OK</div>
			</div>
		</div>

	</div>

</body>
</html>